#!/usr/bin/perl

# Version 0.1.1
use strict;

use Getopt::Std;
use Net::SSH::Perl::Config;

my $dir = "$ENV{HOME}/.jet";

my %o;
getopts('al:', \%o);

sub trigger {
	my $u;
	if($o{'l'}) {
		$u = $o{'l'};
	} else {
		my $h = Net::SSH::Perl::Config->new($_[0]);
		$h->read_config("$ENV{HOME}/.ssh/config");
		$u = $h->get('user');
	}
	print "Trying $u\@$_[0]...\n";
	exec("/usr/bin/ssh -l $u $_[0]");
	exit;
}

mkdir($dir, 0700) unless(-d $dir);

&trigger($ARGV[0]) if $o{'a'} == 1;

my ($m, @m) = 0;
open(KH, '<', "$ENV{HOME}/.ssh/known_hosts");
while(<KH>) {
	s/,/ /;
	split;
	$m = push(@m, $_[0]) if $_[0] =~ $ARGV[0];
}
close(KH);

if($m == 0) {
	print "No match\n";
	exit;
} elsif($m == 1) {
	&trigger($m[0]);
} else {
	@m = sort(@m);
	my ($c, $ch);
	print "$m matches:\n---\n";
	foreach(@m) {
		$c++;
		print "[$c] $_\n";
	}
	print "---\n";
	my $re = '^(' . join('|', (1..$m)) . ')$';
	while($ch !~ /$re/) {
		print "Enter your choice [1-$m]: ";
		$ch = <STDIN>;
	}
	&trigger($m[--$ch]);
}
